## 1. 背景
>大型音乐站的属性库系统
- 音乐站  
>- 特点：百万歌曲MV、千万或亿量级用户、一点即播、百万量级歌词库、下载迅速便利、每周更新百张专辑。
>- 业务特性：在线(web页面)、无线（APP）、本地(PC)。
>- 数据特性：①音乐MV源文件、描述信息；②用户注册信息；③用户行为信息：启动上报服务器、播放记录、点击信息、搜索记录、下载记录、收藏+喜好记录。
- 需求
>建立用户、音乐两个属性库+后台查询系统。可提供的业务方向有：
>1. 在线方向：海量搜索、优化推荐算法、实时计算
>2. 广告方向：精准广告投放(引入用户属性)、实时广告展示和点击量统计
>3. 数据方向：用户属性多维度分析、为数据产品提供底层支持
- 需求范围和系统边界  

>- 需求范围
>1. 建立用户行为库：点击、浏览、播放、搜索、喜好等，清洗整合半结构化为结构化数据
>2. 建立用户属性库：含注册信息，多维度归类——精准广告投放
>3. 建立音乐标签库：音乐分类、自有标签(描述信息)、人工标签、智能标签（自然语言处理和分类、聚类生成）——推荐和用户分类
>4. 建立后台查询系统：数据查询、统计和展示
>5. 相关项目接口：支持推荐、广告和实时系统数据收集+同步，提供API
>- 系统边界
>①旨在为相关产品和研发人员提供平台(API+界面查询)，保证海量数据查询、插入和高并发性能在一定范围内；②包含hbase存储集群、后台管理系统、批量加载、二级索引等模块，不包含sql引擎层、事务性索引、hbase性能优化等；③不包括服务运营、前端开发、运维等。
- 需求详述  

>- 用户行为库  
>>①播放记录：用户播放时长占音乐总时长10%以上，过滤误点击、点击后不感兴趣的记录(数据清洗)；  
②喜好：点击日志中记录用户喜欢和不喜欢的点击信息，入库支持可删(实时)；  
③评分：点击日志中(每天更新)；  
④搜索记录：搜索日志中，需去噪，经大量数据统计确定去噪规则+定期人工审查（每天更新）；  
⑤下载记录：下载日志（每天更新）；  
⑥购买记录：VIP和一般用户产生的付费记录（每天更新）；  
⑦分享记录：微博、微信、空间(每天更新);  
⑧点击宏观分类：播放、点击记录分析出用户分类标签(每天更新)。
>- 用户属性库
>>①基本维度：性别、年龄、所在地区、职业、月收入、学历、婚姻状况。  
②音乐维度：用户与音乐属性库的标签关联关系，从注册信息获取+从行为库分析，得到喜欢的音乐类型、风格、地域等。  
③商业维度：兴趣爱好、广告标签。  
④其他维度：个人标签。
>- 音乐标签库
> 1. 标签组：eg.地域、语言、流派、歌手、热门等；
>2. 标签：eg.地域：内地、港台、日韩、欧美等，标签和标签组是多对多的关系；
>3. 数据来源：原有标签、外网抓取、人工编辑。
>- 后台查询系统
>1. 查询用户信息
>>用户标签ID->UID、独立用户数、地域、男女、职业分布  
UID->topN音乐标签  
UID->音乐ID列表  
1或n个音乐基因数据项->UID列表  
商业属性名称->UID列表  
地域名称或年龄范围->UID列表  
UID可指向个人首页
>2. 查询音乐信息  
>>一个音乐标签->所有音乐  
多个音乐标签->音乐  
音乐ID->音乐信息
>3. 标签维护：标签组合标签的增删改查

>- 监控  
日志数据监控列表和曲线、每天随机抽取UID做hbase和用户中心用户属性的一致性校验、抓取程序监控。

## 2. 概要设计
将需求抽象为软件结构+数据结构，进行模块划分，建立模块层次结构和调用关系，确定模块间的接口和交互界面。
- 数据规模假设  
>用户：亿级、天活跃数：千万级、日志：亿级、音乐：百万级
- 功能指标
>1. 存储能力：亿级用户属性库(历史行为记录和基本属性)，千万量级音乐标签库
>2. 运算查询能力：每秒500量级的实时查询、每秒10000的写入效率、遍历全表在3小时以内。
>3. 统计能力：不超10秒。
>4. 扩展性：数据存储和计算易于扩招、后台管理系统实现可扩展、提供统一接口。
- 系统流程  
>**数据应用层：** 后台查询系统+其他业务应用  
**数据存储层：** hbase属性库、行为库、标签库，统一对外API模块  
**数据处理层：** 对数据层进行日志处理、加载+基本信息加载+抓取模块等操作  
**数据层：** 底层日志(播放、点击、下载、购买、分享)+MySQL+web标签数据  
四者合并即为音乐站属性库架构
## 3. 表结构设计
- 功能抽象  
>music_user_bhvr_attr(注册用户属性库表，属性信息+行为信息)  
music_user_bhvr_attr_index（注册用户属性库索引表，二级索引。反向查询,eg.通过播放音乐id查询对应用户的uid，全表扫描会造成资源浪费，性能差。取代方案为二级索引，定期将数据加载创建倒排索引，利用数据冗余换取访问速度）  
music_user_bhvr_attr_nreg（非注册用户属性库表）  
music_user_bhvr_attr_nreg_index（非注册用户属性库索引表）  
music_tags（音乐标签库表，为统一平台、接口、扩展性等仍旧使用hbase）
- 逻辑结构  
…………………………
- rowkey设计
- 列族设计
>单个列族在flush时，临近列族也会触发flush，导致产生很多IO，故列族不能过多。
>>遵循划分列族隔离原则，将读写频度差距较大的列划分到不同的列族。扩展列族是考虑一期项目暂用不到，线上追求低停顿，有效解决线上添加列族。
- 版本定义
>查询一个用户3个月内播放的所有音乐，hbase的版本可能很方便实现。
- 优化属性定义
BLOOMFILTER、VERSIONS、COMPRESSION
>布隆过滤可每列族单独启用，rowcol行键+列族+列族修饰的哈希每次插入行时将被添加到布隆。
COMPRESSION中，SNAPPY比LZO压缩率稍微低些，但解压速度更快，hbase不能自带LZO。GZIP压缩率更高但速度更慢。

## 4. 数据加载
…………………………
## 5. 数据检索
- hbasetalbe
>用于单表读（get和scan）写（delete和put）操作
- hbaseadmin
>建删表、上下线表、增删改字段  
>集群操作：flush（序列化到硬盘）、compact（合并）、split（拆分）、assign（分配）、balanceSwitch（负载均衡）
- 检索类型
>1. 按rowkey查询：最常用，速度最快，类似hashmap，内网查询在毫秒级别。
>2. 按时间段过滤查询：设置scan的timerange属性，还可以设置列名、版本数量、缓存数量、过滤器等。
>3. 按行分页查询：PageFiler按照rowkey进行分页读取，传入每页行数和上次的rowkey值。
>4. 按版本分页查询：eg.查询一个用户3个月内的播放记录，上万MID，全量读取浪费资源，引入分页，传入rowkey、分页带下、上次时间戳。
## 6. 二级索引
…………………………

