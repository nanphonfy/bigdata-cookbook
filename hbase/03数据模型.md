## 1. 逻辑与物理
>先学特性，逻辑模型、物理模型和访问hbase方法。行和列的交叉点称为单元格(cell，版本化的，内容为字节数组)，无数据类型。

- 逻辑模型
>稀疏、长期存储、多维度和排序的映射表（可理解为Map结构的无限嵌套版本），同一表的记录可以有不同的列名。一个表有若干行，每行多列，列值多版本，每版本的值称为一个单元格。
- 物理模型
>逻辑上表可看为稀疏行的集合，但物理上，表按列族存储，一个列族数据放在多个hfile(面向列、存放行的不同列的物理文件)。不指明时间，返回最新行。

## 2. 重要概念
- 表
>**核心概念：** 表。**无模式数据库：** 表无列定义，无类型。  
>>表把某些列组织起来一起访问，表名将作为HDFS存储路径的一部分。  
列式存储格式允许用户存储大量信息到相同表，因此hbase中表数量相对较少。物理上，存储在不同分区(region，只在一个regionserver提供存储、读取服务)。列族影响物理存储，建表后还可修改。

- 行键  
>不可分割的字节数组。长度不宜过长(占空间，降低检索效率)，尽量均匀(防热点现象)，唯一性。

- 列族
>分隔符`:`用来区分列族前缀和列名。物理上，列族成员在文件系统中存储在一起。新列族可动态、按需加入，修改前要停用表。  
经常一起查询的列放在一个列族(合理划分列族，减少查询时加载到缓存的数据，跨列族很低效)

- 单元格
>由行键、列族、列、时间戳唯一确定。

## 3. 操作
>Get、Put、Scan、Delete。**修改操作保证行级别的原子性**，多客户端或多线程对同一行读写，要么读最新数据，要么等待到允许修改。。每建一个HTable实例都要扫描.META.表，推荐HTablePool类(复用多个HTable实例)。
- Get  
>默认一次返回该行所有列数据，可限定只取某个列族某些列的数据，可取任一版本数据。

- Put  
>**增新行(key是新的)或更新行(key已存在)**，Put操作每次发起一次RPC到服务器，有大量数据时，可利用客户端的缓冲区(默认关闭，需显式开启)批量的仅一次RPC操作发送到服务端。Put集合提交到服务端，部分失败的保持在缓存区重试。

- Scan  
>类似迭代器，可指定startRow、stopRow扫描读取起止行键。创建Scan实例后，无参数将扫全表(所有列族和列)，可增加更多限定条件来限定读取的数据。

- Delete
>可指定删除某个列族、列、时间戳、比某时间早的数据，不是真正从磁盘删除，而是创建墓碑标志，大合并清除。

## 4. 特殊属性
- 版本
>rowkey、column、version组合，称为一个单元格。version用长整型表示(毫秒)。  
get或scan想返回>2个版本，使用setMaxVersions()；  
put，默认使用当前时间戳，也可手动指定过去、未来；  
delete，使用墓碑标记来屏蔽值，不会立即从文件删除。 

- 排序
>数据首先按行字典排序，其次是列族，然后是列修饰符，最后是时间戳反向排序。

- 列的元数据
>对于列族，除KeyValue实例，无元数据描述。KeyValue对象表示hbase的最小单位是Cell。
- 连接查询
>不支持join查询，但用户可自行实现：①写入hbase时已经做好连接；②查询表并在应用层实现连接。
- 计数器
>ICV(IncrementColumnValue)是hbase的计数器，做PV(页面浏览量)可用。没有它，要读单元格值加1再存入。ICV发生在regionserver不在客户端，速度快，可避免不一致。
- 原子操作
>checkAndPut()和checkAndDelete()维持原子性。
- 事务特性ACID
>仅保证行级原子性，同时对同一key操作，会串行不破坏KeyValue。同一region有多行原子性，对一个多region表来说，还是无法保证每次修改都能封装为一个事务。

- 行锁
>regionserver提供行锁特性，保障只有一个客户端能获取一行数据相应锁，同时对该行进行修改。

- 自动分区
>刚创建的表只有一个region，随着数据增大，达到region上限，会按照中间键自动拆分为两相似大小的region(每个region（1-20GB）由一个regionserver管理，一个regionserver管理多个（100-1000个）region)。  
region的拆分和转移由hbase自动完成，当一个regionserver故障，region可快速转移到其他服务器，region拆分过程（首先将该region下线offline，拆分完后新的region上线online）也是瞬间完成的。

## CAP原理与最终一致性
>CAP原理是数据库的理论基础。
>1. 一致性(consistency)：所有节点在同一时间具有相同数据；
>2. 可用性(availability)：保证每个请求不管成功失败都有响应；
>3. 分区容忍性(partition tolerance)：系统任意信息丢失或失败，不影响系统继续运作。
>>分布式数据库一般只能满足其中两项。当前网络硬件定会延迟丢包，故分区容忍性必须实现。大部分数据库选择牺牲一致性提高可用性。  
**Hbase的设计：** 首先不要求严格的数据库事务，保证数据最终一致性即可；不能实时读取刚写入的数据；集中在针对主键查询。