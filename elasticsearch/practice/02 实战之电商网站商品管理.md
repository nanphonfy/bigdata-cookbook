## 集群健康检查，文档CRUD
>1、document数据格式;  
2、电商网站商品管理案例：背景介绍;  
3、简单的集群管理;  
4、商品的CRUD操作（document CRUD操作）.

###document数据格式
- 面向文档的搜索分析引擎
>（1）应用系统的数据结构都是面向对象的，复杂的;  
（2）对象数据存储到数据库中，只能拆解开来，变为扁平的多张表，每次查询的时候还得还原回对象格式，相当麻烦;  
（3）ES是面向文档的，文档中存储的数据结构，与面向对象的数据结构是一样的，基于这种文档数据结构，es可以提供复杂的索引，全文检索，分析聚合等功能;  
（4）es的document用json数据格式来表达

```JAVA
public class Employee {
  private String email;
  private String firstName;
  private String lastName;
  private EmployeeInfo info;
  private Date joinDate;
}

private class EmployeeInfo {
  private String bio; // 性格
  private Integer age;
  private String[] interests; // 兴趣爱好
}

EmployeeInfo info = new EmployeeInfo();
info.setBio("curious and modest");
info.setAge(30);
info.setInterests(new String[]{"bike", "climb"});

Employee employee = new Employee();
employee.setEmail("zhangsan@sina.com");
employee.setFirstName("san");
employee.setLastName("zhang");
employee.setInfo(info);
employee.setJoinDate(new Date());
```
>employee对象：里面包含了Employee类自己的属性，还有一个EmployeeInfo对象;  
两张表：employee表，employee_info表，将employee对象的数据重新拆开来，变成Employee数据和EmployeeInfo数据;  
employee表：email，first_name，last_name，join_date，4个字段;  
employee_info表：bio，age，interests，3个字段；此外还有一个外键字段，比如employee_id，关联着employee表.  

```
{
    "email":      "zhangsan@sina.com",
    "first_name": "san",
    "last_name": "zhang",
    "info": {
        "bio":         "curious and modest",
        "age":         30,
        "interests": [ "bike", "climb" ]
    },
    "join_date": "2017/01/01"
}
```
我们就明白了es的document数据格式和数据库的关系型数据格式的区别。

### 电商网站商品管理案例背景介绍
有一个电商网站，需要为其基于ES构建一个后台系统，提供以下功能：  
>（1）对商品信息进行CRUD（增删改查）操作；  
（2）执行简单的结构化查询；  
（3）可以执行简单的全文检索，以及复杂的phrase（短语）检索；  
（4）对于全文检索的结果，可以进行高亮显示；  
（5）对数据进行简单的聚合分析。

### 简单的集群管理
- 快速检查集群的健康状况
>es提供了一套api，叫做cat api，可以查看es中各种各样的数据  

`GET /_cat/health?v`
```
epoch      timestamp cluster       status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent
1488006741 15:12:21  elasticsearch yellow          1         1      1   1    0    0        1             0                  -                 50.0%

epoch      timestamp cluster       status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent
1488007113 15:18:33  elasticsearch green           2         2      2   1    0    0        0             0                  -                100.0%

epoch      timestamp cluster       status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent
1488007216 15:20:16  elasticsearch yellow          1         1      1   1    0    0        1             0                  -                 50.0%
```

- 如何快速了解集群的健康状况？

>green：每个索引的primary shard和replica shard都是active状态的;
yellow：每个索引的primary shard都是active状态的，但是部分replica shard不是active状态，处于不可用的状态;
red：不是所有索引的primary shard都是active状态的，部分索引有数据丢失了.

- 为什么现在会处于一个yellow状态？
>我们现在就一个笔记本电脑，就启动了一个es进程，相当于就只有一个node。现在es中有一个index，就是kibana自己内置建立的index。由于默认的配置是给每个index分配5个primary shard和5个replica shard，而且primary shard和replica shard不能在同一台机器上（为了容错）。现在kibana自己建立的index是1个primary shard和1个replica shard。当前就一个node，所以只有1个primary shard被分配了和启动了，但是一个replica shard没有第二台机器去启动。  
>>做一个小实验：此时只要启动第二个es进程，就会在es集群中有2个node，然后那1个replica shard就会自动分配过去，然后cluster status就会变成green状态。