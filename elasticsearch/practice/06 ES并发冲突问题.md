### 深度图解剖析Elasticsearch并发冲突问题
>电商场景：  
`程序工作流程：①读取商品信息(包括商品库存)；②用户下单；③更新商品信息(将库存减一)。`


>假设程序为多线程，可并发执行上述3步骤。
>- 有一款牙膏，库存100件，同时有两位用户读取牙膏数据分别购买，此时两个线程并发服务于两个人，同时在进行商品库存数据修改。  
这两个线程总有一个线程是先到的，假设为A，此时线程A会将牙膏库存设置为99件，然后线程B再次将牙膏库存设置为99件，此时结果就错了。  
正确情况，期望线程A将库存-1，设置为99件；然后线程B接着将库存-1，设置为98件，最后设置到ES中。  
>>上面说的流程和过程，就是ES中的并发冲突问题，会导致数据不准确。  
>>- ①有些场景下，不关心数据准确性。eg.若只是简单将数据写入ES，无论数据如何，都可以；甚至有些情况，算错了也可以。
>>- ②当并发操作ES的线程越多，或并发请求越多，或读取一份数据供用户查询、操作时间越长，可能这段时间内数据在ES中已被修改，那我们拿到的就是旧数据，基于旧数据去操作，结果肯定错了。

- 普通ES操作流程：  
>①先get document，商品信息，显示到网页，同时在内存中缓存该document数据；  
②当网页发起购买，直接基于内存的数据，进行计算和操作；  
③将计算后的结果写回ES中。