
高并发系统用缓存、降级和限流做保护。
>- **缓存：** 提升访问速度、增大处理能力，抗高并发流量；
>- **降级：** 服务出问题或影响核心流程的性能时，需暂时屏蔽掉，待高峰过后再打开；
>>但在某些场景，eg.稀缺资源（秒杀、抢购）、写服务（评论、下单）、频繁复杂查询（评论最后几页）不能用以上两种来解决，
需限流来限制并发/请求量。
>- **限流目的：** 对并发请求或一个时间窗口内进行限速，达到限制速率拒绝服务（定向到错误页或告知无资源）、排队或等待（秒杀、评论、下单）、降级（返回兜底数据或默认数据，eg.商品详情页库存默认有货）

>①压测找出系统处理峰值，再设定阈值；  
②也可根据系统吞吐量、响应时间、可用率动态调整限流阈值。

**常见限流：**
>限制总并发数（eg.数据库连接池、线程池）、限制瞬时并发数（nginx的limit_conn模块）、限制时间窗口内的平均速率（guava的RateLimiter、nginx的limit_req模块）、限制远程接口调用速率、限制MQ的消费速率等。  
还可根据网络连接数、网络流量、CPU或内存复制等限流。

### 1. 限流算法
常见：令牌桶、漏桶、计数器（粗暴实现）
- 令牌桶算法
>存放固定容量令牌的桶，按固定速率往桶里添加令牌。   
>>①限速10r/s，按100毫秒固定速率填充令牌，填满了则丢弃令牌；  
②请求的速率可突发，并且令牌桶允许这种突发；  
③获取令牌；  
④处理请求。
- 漏桶算法
>固定容量的漏桶，按常量固定速率流出水滴。  
>>①流入水滴速率任意；  
②若流入速率过快，超过了桶的容量，则直接丢弃水滴；  
③按照常量速率流出水滴。  

- 对比  
>①令牌桶按固定速率往桶中加令牌，令牌足够请求才能被处理；  
②漏桶按常量固定速率流出请求，流入请求速率任意，累积到漏桶容量时，拒绝新流入请求；  
③令牌桶限制平均流入速率，漏桶限制常量流出速率；  
④令牌桶允许一定程度突发，漏桶目的是平滑流入速率；

- 计数器限流
>限制总并发数，eg.数据库连接池、线程池大小核秒杀并发数。简单粗暴的总数量限流。

